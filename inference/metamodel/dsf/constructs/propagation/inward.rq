PREFIX : <https://openprovenance.org/ns/facet/dsf#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# INWARD PROPAGATION: From parent container to children
# Handles both conditional and unconditional propagation
# Automatically copies parameter values

CONSTRUCT {
  ?newAssertion rdf:type :ComplianceAssertion ;
                :assertedByFramework ?framework ;
                :assertedInScope ?scope ;
                :assertedOn ?child ;
                :assertsLabel ?label ;
                :derivedFrom ?parentAssertion ;
                :derivedVia :InwardPropagation ;
                :hasParameterValue ?paramValue .
}
WHERE {
  # Parent has an assertion
  ?parentAssertion rdf:type :ComplianceAssertion ;
                   :assertsLabel ?label ;
                   :assertedInScope ?scope ;
                   :assertedOn ?parent ;
                   :assertedByFramework ?framework .

  # Framework has inward propagation rule for this label
  ?framework :hasPropagationRule ?rule .
  ?rule :propagatesLabel ?label ;
        :propagationBehavior :Inward .

  # Parent contains child
  ?parent :contains ?child .

  # Check condition if specified (same pattern as ConditionalEquivalence)
  # COMMENTED OUT FOR PERFORMANCE - conditional propagation disabled
  # OPTIONAL {
  #   ?rule :hasCondition ?condition .
  #   ?eval rdf:type :ConditionEvaluation ;
  #         :evaluatesCondition ?condition ;
  #         :evaluatedOn ?child ;
  #         :evaluatedInScope ?scope ;
  #         :evaluationResult "true"^^xsd:boolean .
  # }
  #
  # # Propagate if either:
  # # 1. No condition specified (!BOUND(?condition))
  # # 2. Condition exists and is satisfied (BOUND(?eval))
  # FILTER (!BOUND(?condition) || BOUND(?eval))

  # Create new assertion URI using skolemization pattern
  BIND(IRI(CONCAT("urn:skolem:",
                  ENCODE_FOR_URI(STR(?child)), "_",
                  ENCODE_FOR_URI(STR(?label)), "_",
                  ENCODE_FOR_URI(STR(?framework)), "_",
                  ENCODE_FOR_URI(STR(?scope)), "_assertion")) AS ?newAssertion)

  # Copy parameter values if they exist
  OPTIONAL { ?parentAssertion :hasParameterValue ?paramValue }

  # Check that this assertion doesn't already exist
  FILTER NOT EXISTS { ?newAssertion rdf:type :ComplianceAssertion }
}
